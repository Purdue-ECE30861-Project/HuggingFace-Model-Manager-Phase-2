name: Deploy backend to ec2

on:
    push:
        branches: [ "main" ]

permissions:
    contents: read

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: install dependencies
              run: |
                sudo snap install aws-cli --classic
            - name: Copy files to EC2
              env: 
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
                EC2_USER: ${{ secrets.EC2_USER }}
                EC2_INSTANCE: ${{ secrets.EC2_INSTANCE }}
                REPO_PRIVATE_KEY: ${{ secrets.REPO_PRIVATE_KEY }}
                REPO_PUBLIC_KEY: ${{ secrets.REPO_PUBLIC_KEY }}
                EC2_PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
              run: |
                mkdir -p ~/.aws
                cat << EOF > ~/.aws/config 
                [default]
                region = us-east-2
                EOF
                aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
                aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
                aws configure set aws_session_token "$AWS_SESSION_TOKEN"
                aws ec2 start-instances --instance-ids $EC2_INSTANCE
                # final setup
                public_ip=$(aws ec2 describe-instances --instance-ids $EC2_INSTANCE | grep "PublicIpAddress" | sed 's/"PublicIpAddress": //g' | sed 's/["|"]//g' | awk '{$1=$1};1')
                echo "$EC2_PRIVATE_KEY" > ec2_key.pem
                chmod 600 ec2_key.pem
                # all following code until ENDSSH runs on ec2 instance
                ssh -o StrictHostKeyChecking=no -i ec2_key.pem $EC2_USER@$public_ip << 'ENDSSH'
                mkdir -p ~/.ssh/
                echo "${{ secrets.REPO_PRIVATE_KEY }}" > ~/.ssh/id_github
                chmod 600 ~/.ssh/id_github
                echo "${{ secrets.REPO_PUBLIC_KEY }}" > ~/.ssh/id_github.pub
                eval $(ssh-agent)
                ssh-add ~/.ssh/id_github
                mkdir -p ~/tmp
                cd ~/tmp
                ssh-keyscan github.com >> ~/.ssh/known_hosts
                git clone git@github.com:Purdue-ECE30861-Project/HuggingFace-Model-Manager-Phase-2.git
                sudo mkdir -p /opt/hfmm
                sudo chown ${{ secrets.EC2_USER }}:www-data /opt/hfmm
                sudo chmod 775 /opt/hfmm
                sudo apt install -y python3 python3.12-venv nginx
                cd /opt/hfmm
                cp -r ~/tmp/HuggingFace-Model-Manager-Phase-2/src/ .
                cp -r ~/tmp/HuggingFace-Model-Manager-Phase-2/requirements.txt .
                python3 -m venv venv
                source venv/bin/activate
                pip3 install -r requirements.txt
                pip3 install uvicorn
                sudo cp -rf src/backend_server/server_components/nginx/hfmm /etc/nginx/sites-available/hfmm
                sudo ln -s /etc/nginx/sites-available/hfmm /etc/nginx/sites-enabled/hfmm
                sudo unlink /etc/nginx/sites-enabled/default
                sudo cp -rf src/backend_server/server_components/services/* /etc/systemd/system/hfmm.service
                rm -r ~/tmp/*
                sudo systemctl daemon-reload
                sudo systemctl enable nginx
                sudo systemctl restart nginx
                sudo systemctl enable hfmm
                sudo systemctl restart hfmm
                ENDSSH
                rm -r ~/.aws
                rm ec2_key.pem

