limit_req_zone $binary_remote_addr zone=mylimit:10m rate=7r/s;

server{
        listen 80 default_server;

        location / {
                limit_req zone=mylimit burst=15 nodelay;
                proxy_set_header Host $http_host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
                proxy_redirect off;
                proxy_buffering off;
                proxy_pass http://uvicorn;
        }

        location /static {
                limit_req zone=mylimit burst=15 nodelay;
                root /opt/hfmm;
        }
}

map $http_upgrade $connection_upgrade{
        default upgrade;
        '' close;
}

upstream uvicorn {
        server unix:/opt/hfmm/hfmm.sock;
}