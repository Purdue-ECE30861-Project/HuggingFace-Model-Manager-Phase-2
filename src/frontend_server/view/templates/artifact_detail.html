{% extends "base.html" %}

{% block title %}{{ artifact.get('metadata', {}).get('name', 'Artifact') }} - Model Registry{% endblock %}

{% block extra_head %}
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: #fefefe;
        padding: 2rem;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .modal-close:hover {
        color: black;
    }
</style>
{% endblock %}

{% block content %}
{% set metadata = artifact.get('metadata', {}) %}
{% set artifact_type = metadata.get('type', 'unknown') %}
{% set artifact_id = metadata.get('id', 'N/A') %}
{% set data = artifact.get('data', {}) %}

<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-4xl font-bold text-gray-800">{{ metadata.get('name', 'Unnamed') }}</h1>
            <p class="text-black-100 mt-2">ID: <code class="px-2 py-1 rounded">{{ artifact_id }}</code></p>
        </div>
        <div class="flex space-x-3">
            <button onclick="openModal('editModal')"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                Edit
            </button>
            {% if artifact_type == "model" %}
            <button onclick="openModal('licenseModal')"
                class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition">
                Check License
            </button>
            {% endif %}
            <button onclick="deleteArtifact()"
                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">
                Delete
            </button>
            <a href="/" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">
                Back
            </a>
        </div>
    </div>

    <!-- Basic Info -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Basic Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <p class="text-sm font-semibold text-gray-600">Type</p>
                <p class="text-lg text-gray-800">{{ artifact_type.title() }}</p>
            </div>
            <div>
                <p class="text-sm font-semibold text-gray-600">Source URL</p>
                <a href="{{ data.get('url', '#') }}" target="_blank"
                    class="text-lg text-blue-600 hover:text-blue-800 break-all">
                    {{ data.get('url', 'N/A') }}
                </a>
            </div>
            {% if data.get('download_url') %}
            <div class="md:col-span-2">
                <a href="{{ data.get('download_url') }}" target="_blank"
                    class="inline-block bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">
                    Download
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Rating (for models) -->
    {% if artifact_type == 'model' and rating %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Model Rating</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Overall Score -->
            <div class="col-span-1 md:col-span-2">
                <div class="text-center p-6 bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg">
                    <p class="text-sm font-semibold text-gray-600 mb-2">Overall Score</p>
                    <p class="text-5xl font-bold text-purple-600">
                        {% set overall_score = rating.get('net_score', 'N/A') %}
                        {% if overall_score != 'N/A' %}
                        {{ '{0:0.2%}'.format(overall_score) }}
                        {% else %}
                        N/A
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Individual Metrics -->
            {% set metrics = [
            ('Bus Factor', 'bus_factor'),
            ('Code Quality', 'code_quality'),
            ('Dataset Quality', 'dataset_quality'),
            ('License Compatibility', 'license'),
            ('Performance Claims', 'performance_claims'),
            ('Ramp Up Time', 'ramp_up_time'),
            ('Dataset and Code Availability', 'dataset_and_code_score'),
            ('Reproducibility', 'reproducibility'),
            ('Reviewedness', 'reviewedness'),
            ('Tree score', 'tree_score'),
            ] %}

            {% for label, key in metrics %}
            {% set value = rating.get(key, 'N/A') %}
            {% if value != 'N/A' %}
            <div>
                <p class="text-sm font-semibold text-gray-600">{{ label }}</p>
                <div class="bg-gray-200 rounded-full h-6 mt-2 overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 h-full flex items-center justify-center text-white text-xs font-bold"
                        style="width: {{ (value * 100)|int }}%">
                        {% if (value * 100)|int > 10 %}{{ "%.1f"|format(value) }}{% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}

            {% set size_score = rating.get('size_score')%}
            {% if size_score %}
            <!-- size scores -->
            {% set platforms = [
            ('Size Score (Raspberry Pi)', 'raspberry_pi'),
            ('Size Score (Jetson Nano)', 'jetson_nano'),
            ('Size Score (Desktop PC)', 'desktop_pc'),
            ('Size Score (AWS Server)', 'aws_server'),
            ] %}
            {% for label, key in platforms %}
            {% set value = size_score.get(key, 'N/A') %}
            {% if value != 'N/A' %}
            <div>
                <p class="text-sm font-semibold text-gray-600">{{ label }}</p>
                <div class="bg-gray-200 rounded-full h-6 mt-2 overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 h-full flex items-center justify-center text-white text-xs font-bold"
                        style="width: {{ (value * 100)|int }}%">
                        {% if (value * 100)|int > 10 %}{{ "%.1f"|format(value) }}{% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Lineage (for models) -->
    {% if artifact_type == 'model' and lineage %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Lineage Graph</h2>
        {% if lineage.get('nodes') %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b-2 border-gray-300">
                        <th class="text-left py-2 px-4">Name</th>
                        <th class="text-left py-2 px-4">Source</th>
                        <th class="text-left py-2 px-4">Original Location</th>
                    </tr>
                </thead>
                <tbody>
                    {% for node in lineage.nodes %}
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-2 px-4 font-mono text-sm">{{ node.get('name', 'N/A') }}</td>
                        <td class="py-2 px-4">{{ node.get('source', 'N/A').replace("_", " ").title() }}</td>

                        <td class="py-2 px-4 text-gray-600 text-sm">
                            {% if node.get('metadata') %}
                            <a class="text-lg text-blue-600 hover:text-blue-800 break-all"
                                href="{{ node.get('metadata').get('url') }}">Here</a>
                            {% else %}
                            N/A
                            {% endif %}
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if lineage.get('edges') %}
        <div class="mt-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Relationships</h3>
            <div class="space-y-2">
                {% for edge in lineage.edges %}
                <p class="text-gray-700 font-mono text-sm">
                    <code>{{ edge.get('from_node_artifact_id', 'N/A') }}</code>
                    <span>{{ edge.get('relationship', 'â†’') }}</span>
                    <code>{{ edge.get('to_node_artifact_id', 'N/A') }}</code>
                </p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% else %}
        <p class="text-gray-500">No lineage information available</p>
        {% endif %}
    </div>
    {% endif %}

    <!-- Cost Information -->
    {% if cost %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Cost Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for key, value in cost.items() %}
            <div>
                <p class="text-sm font-semibold text-gray-600">{{ key.replace('_', ' ').title() }}</p>
                {% if value is mapping %}
                <div class="mt-2 space-y-1">
                    {% for subkey, subvalue in value.items() %}
                    <p class="text-gray-700"><span class="font-mono text-sm">{{ subkey }}:</span> {{ subvalue }}</p>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-lg font-semibold text-purple-600">{{ value }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- License Check Result (if available) -->
    {% if license_result is defined and license_result != None %}
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">License Check Result</h2>
        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
            <p class="text-gray-700">Checked against: <code
                    class="bg-gray-100 px-2 py-1 rounded">{{ github_url }}</code></p>
            <pre class="mt-4 text-sm overflow-x-auto">
                {% if license_result %}
                Compatible.
                {% else %}
                Incompatible.
                {% endif %}
            </pre>
        </div>
    </div>
    {% endif %}
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('editModal')">&times;</span>
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Edit Artifact</h2>
        <form method="post" action="/artifact/{{ artifact_type }}/{{ artifact_id }}/update" class="space-y-4">
            <div>
                <label for="name" class="block text-sm font-semibold text-gray-600 mb-2">Name</label>
                <input type="text" id="name" name="name" value="{{ metadata.get('name', '') }}"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    required>
            </div>
            <div>
                <label for="url" class="block text-sm font-semibold text-gray-600 mb-2">Source URL</label>
                <input type="url" id="url" name="url" value="{{ data.get('url', '') }}"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    required>
            </div>
            <div class="flex space-x-3">
                <button type="submit"
                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">
                    Update Artifact
                </button>
                <button type="button" tabindex="0" onclick="closeModal('editModal')"
                    class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- License Check Modal -->
<div id="licenseModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" tabindex="0" onclick="closeModal('licenseModal')">&times;</span>
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Check License Compatibility</h2>
        <form method="post" action="/artifact/{{ artifact_type }}/{{ artifact_id }}/license-check" class="space-y-4">
            <div>
                <label for="github_url" class="block text-sm font-semibold text-gray-600 mb-2">GitHub Repository
                    URL</label>
                <input type="url" id="github_url" name="github_url" placeholder="https://github.com/user/repo"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    required>
                <p class="text-xs text-gray-500 mt-2">Enter the GitHub URL to check license compatibility with this
                    artifact</p>
            </div>
            <div class="flex space-x-3">
                <button type="submit"
                    class="flex-1 bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition">
                    Check License
                </button>
                <button type="button" onclick="closeModal('licenseModal')"
                    class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function deleteArtifact() {
        if (confirm('Are you sure you want to delete this artifact? This action cannot be undone.')) {
            const form = document.createElement('form');
            form.method = 'DELETE';
            form.action = '/artifact/{{ artifact_type }}/{{ artifact_id }}';
            document.body.appendChild(form);

            // Since DELETE is not directly supported in HTML forms, we'll use a workaround
            fetch('/artifact/{{ artifact_type }}/{{ artifact_id }}', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    confirm('Artifact successfully deleted');
                    window.location.href = '/';
                } else {
                    alert('Failed to delete artifact');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('Error deleting artifact');
            });
        }
    }

    // Close modal when clicking outside of it
    window.onclick = function (event) {
        const editModal = document.getElementById('editModal');
        const licenseModal = document.getElementById('licenseModal');
        if (event.target === editModal) {
            closeModal('editModal');
        }
        if (event.target === licenseModal) {
            closeModal('licenseModal');
        }
    }
</script>
{% endblock %}